<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QREES - Money Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .toggle-btn.active-blue {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(37 99 235 / 0.3);
        }

        .toggle-btn.active-yellow {
            background-color: #eab308;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(234 179 8 / 0.3);
        }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <!-- ================= LOGIN SECTION ================= -->
    <div id="login-section" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <div class="mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-blue-200 mb-4">
                    <i class="fa-solid fa-wallet text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">Welcome Back</h1>
                <p class="text-gray-500 text-sm mt-1">Enter PIN to access your wallet.</p>
            </div>
            <div class="flex justify-center gap-3 mb-8">
                <div class="pin-dot w-4 h-4 rounded-full border-2 border-gray-300 transition-all duration-200"></div>
                <div class="pin-dot w-4 h-4 rounded-full border-2 border-gray-300 transition-all duration-200"></div>
                <div class="pin-dot w-4 h-4 rounded-full border-2 border-gray-300 transition-all duration-200"></div>
                <div class="pin-dot w-4 h-4 rounded-full border-2 border-gray-300 transition-all duration-200"></div>
                <div class="pin-dot w-4 h-4 rounded-full border-2 border-gray-300 transition-all duration-200"></div>
                <div class="pin-dot w-4 h-4 rounded-full border-2 border-gray-300 transition-all duration-200"></div>
            </div>
            <p id="pin-error" class="text-red-500 text-sm h-5 mb-4 opacity-0">Wrong PIN, please try again.</p>
            <div class="grid grid-cols-3 gap-4 max-w-[280px] mx-auto" id="keypad-container">
                <button onclick="enterDigit(1)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">1</button>
                <button onclick="enterDigit(2)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">2</button>
                <button onclick="enterDigit(3)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">3</button>
                <button onclick="enterDigit(4)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">4</button>
                <button onclick="enterDigit(5)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">5</button>
                <button onclick="enterDigit(6)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">6</button>
                <button onclick="enterDigit(7)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">7</button>
                <button onclick="enterDigit(8)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">8</button>
                <button onclick="enterDigit(9)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">9</button>
                <div class="h-14"></div>
                <button onclick="enterDigit(0)" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200">0</button>
                <button onclick="deleteDigit()" class="h-14 rounded-full text-xl font-semibold bg-gray-50 active:bg-gray-200 text-gray-500">
                    <i class="fa-solid fa-delete-left"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ================= DASHBOARD SECTION ================= -->
    <div id="dashboard-section" class="hidden flex-col h-full max-w-md mx-auto w-full bg-gray-50 shadow-2xl relative fade-in">
        <header class="bg-white px-6 pt-8 pb-4 flex justify-between items-start sticky top-0 z-10 border-b border-gray-100">
            <div>
                <h2 class="text-blue-600 font-bold text-lg tracking-wide">QREES</h2>
                <p class="text-gray-400 text-xs mt-0.5">Your Money Management</p>
            </div>
            <div class="text-right">
                <p id="current-day" class="text-gray-900 font-semibold text-sm">Monday</p>
                <p id="current-date" class="text-gray-500 text-xs">January 1, 2024</p>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar px-6 pb-24">
            <!-- Wallet Card -->
            <div class="mt-6 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-3xl p-6 text-white shadow-xl shadow-blue-200 relative overflow-hidden transition-all duration-300">
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-blue-100 text-xs font-medium uppercase tracking-wider">Main Wallet</span>
                        <button onclick="toggleBalance()" class="text-blue-100 hover:text-white transition focus:outline-none p-1">
                            <i id="eye-icon" class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                    <h1 id="wallet-balance" class="text-3xl font-bold tracking-tight mb-6">Rp 0</h1>
                    <div class="flex items-end justify-between">
                        <div>
                            <p class="text-blue-200 text-[10px] uppercase font-semibold mb-0.5">Savings</p>
                            <p id="savings-balance" class="font-semibold text-base">Rp 0</p>
                        </div>
                        <div class="text-right">
                            <p class="text-blue-200 text-[10px] uppercase font-semibold mb-0.5">Total Assets</p>
                            <p id="total-assets" class="font-bold text-sm text-white">Rp 0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Grid -->
            <div class="grid grid-cols-3 gap-3 mt-6">
                <button onclick="openModal('in')" class="flex flex-col items-center justify-center gap-2 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition">
                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i class="fa-solid fa-plus"></i></div>
                    <span class="text-gray-700 font-bold text-[11px] uppercase">Income</span>
                </button>
                <button onclick="openModal('out')" class="flex flex-col items-center justify-center gap-2 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition">
                    <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="fa-solid fa-minus"></i></div>
                    <span class="text-gray-700 font-bold text-[11px] uppercase">Expense</span>
                </button>
                <button onclick="openBankModal()" class="flex flex-col items-center justify-center gap-2 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-building-columns"></i></div>
                    <span class="text-gray-700 font-bold text-[11px] uppercase">Bank</span>
                </button>
            </div>

            <!-- Recent History -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 text-lg">Recent Activities</h3>
                    <button onclick="showFullHistory()" class="text-blue-600 text-xs font-semibold">See All</button>
                </div>
                <div id="dashboard-history-list" class="space-y-3">
                </div>
            </div>
        </main>
    </div>

    <!-- ================= FULL HISTORY SECTION ================= -->
    <div id="history-section" class="hidden flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative fade-in">
        <header class="bg-white px-6 pt-8 pb-4 border-b border-gray-100 sticky top-0 z-10 flex items-center gap-4">
            <button onclick="showDashboard()" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition">
                <i class="fa-solid fa-arrow-left text-gray-700"></i>
            </button>
            <h2 class="text-gray-900 font-bold text-lg">All Transactions</h2>
        </header>
        <main class="flex-1 overflow-y-auto px-6 py-4 pb-24 no-scrollbar" id="full-history-container"></main>
    </div>

    <!-- ================= BANK MODAL ================= -->
    <div id="bank-modal" class="fixed inset-0 z-[60] hidden bg-black/50 backdrop-blur-sm flex items-end justify-center transition-opacity opacity-0">
        <div class="bg-white w-full max-w-md rounded-t-3xl p-6 transform translate-y-full transition-transform duration-300" id="bank-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Bank Transfer</h3>
                <button onclick="closeBankModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="bg-gray-100 p-1 rounded-xl flex mb-6">
                <button id="toggle-save" onclick="setBankMode('save')" class="toggle-btn active-blue flex-1 py-2.5 rounded-lg text-sm font-bold transition-all">Saving</button>
                <button id="toggle-withdraw" onclick="setBankMode('withdraw')" class="toggle-btn flex-1 py-2.5 rounded-lg text-sm font-bold transition-all">Withdraw</button>
            </div>

            <form onsubmit="handleBankSubmit(event)">
                <div class="mb-5">
                    <label class="block text-gray-400 text-[10px] font-bold uppercase mb-1">Amount (IDR)</label>
                    <input type="text" id="bank-amount" required inputmode="numeric" oninput="formatInputCurrency(this)" class="w-full text-3xl font-bold text-gray-800 border-b-2 border-gray-100 focus:border-blue-500 outline-none py-2 bg-transparent font-mono" placeholder="0">
                </div>

                <div id="desc-container" class="mb-8">
                    <label class="block text-gray-400 text-[10px] font-bold uppercase mb-1">Description (Optional)</label>
                    <select id="bank-desc-saving" class="w-full text-base text-gray-700 border-b-2 border-gray-100 focus:border-blue-500 outline-none py-2 bg-transparent">
                        <option value="">- Default Description -</option>
                    </select>
                    <input type="text" id="bank-desc-withdraw" class="hidden w-full text-base text-gray-700 border-b-2 border-gray-100 focus:border-blue-500 outline-none py-2 bg-transparent" placeholder="Why withdraw?">
                </div>

                <button type="submit" id="bank-submit-btn" class="w-full py-4 rounded-xl bg-blue-600 text-white font-bold text-lg shadow-lg active:scale-[0.98] transition">Confirm Saving</button>
            </form>
        </div>
    </div>

    <!-- ================= STANDARD TRANSACTION MODAL ================= -->
    <div id="transaction-modal" class="fixed inset-0 z-[60] hidden bg-black/50 backdrop-blur-sm flex items-end justify-center transition-opacity opacity-0">
        <div class="bg-white w-full max-w-md rounded-t-3xl p-6 transform translate-y-full transition-transform duration-300" id="trans-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">New Activity</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form onsubmit="handleTransSubmit(event)">
                <input type="hidden" id="trans-type">
                <div class="mb-5">
                    <label class="block text-gray-400 text-[10px] font-bold uppercase mb-1">Amount (IDR)</label>
                    <input type="text" id="trans-amount" required inputmode="numeric" oninput="formatInputCurrency(this)" class="w-full text-3xl font-bold text-gray-800 border-b-2 border-gray-100 focus:border-blue-500 outline-none py-2 bg-transparent font-mono" placeholder="0">
                </div>
                <div class="mb-8">
                    <label class="block text-gray-400 text-[10px] font-bold uppercase mb-1">Description (Optional)</label>
                    <input type="text" id="trans-desc" class="w-full text-base text-gray-700 border-b-2 border-gray-100 focus:border-blue-500 outline-none py-2 bg-transparent" placeholder="What's this for?">
                </div>
                <button type="submit" id="modal-submit-btn" class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg active:scale-[0.98] transition">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- ================= DETAIL CARD ================= -->
    <div id="detail-modal" class="fixed inset-0 z-[70] hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 opacity-0 transition-opacity">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl transform scale-95 transition-transform" id="detail-card-content">
            <div class="flex flex-col items-center text-center">
                <div id="det-icon-bg" class="w-14 h-14 rounded-full flex items-center justify-center mb-4 text-xl">
                    <i id="det-icon" class="fa-solid"></i>
                </div>
                <h3 id="det-desc" class="font-bold text-lg text-gray-900 mb-1 capitalize"></h3>
                <p id="det-type" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4"></p>
                <div class="w-full bg-gray-50 rounded-2xl p-4 mb-4">
                    <span class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Total Amount</span>
                    <span id="det-amount" class="text-xl font-bold"></span>
                </div>
                <div class="w-full text-left space-y-2 text-sm border-t border-gray-100 pt-4">
                    <div class="flex justify-between"><span class="text-gray-400">Date</span><span id="det-date" class="font-semibold"></span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Time</span><span id="det-time" class="font-semibold font-mono"></span></div>
                </div>
                <button onclick="closeDetail()" class="mt-6 w-full py-3 rounded-xl bg-gray-100 text-gray-600 font-bold text-sm">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        const PIN_SECRET = "501943";
        let currentPin = "";
        let balance = 0, savings = 0, transactions = [], isHidden = false;
        let bankMode = 'save';

        // --- INIT ---
        window.onload = () => {
            loadData();
            updateHeader();
            renderDashboard();
            generateSavingOptions();
        };

        function formatCurrency(n) {
            return "Rp " + new Intl.NumberFormat('id-ID').format(n);
        }

        function formatInputCurrency(el) {
            let val = el.value.replace(/\D/g, '');
            el.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function parseCurrency(str) {
            return parseInt(str.replace(/\./g, '') || '0');
        }

        function updateHeader() {
            const now = new Date();
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('current-day').innerText = days[now.getDay()];
            document.getElementById('current-date').innerText = `${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
        }

        // --- AUTH ---
        function enterDigit(d) {
            if (currentPin.length < 6) {
                currentPin += d;
                updateDots();
                if (currentPin.length === 6) setTimeout(checkPin, 250);
            }
        }
        function deleteDigit() {
            currentPin = currentPin.slice(0, -1);
            updateDots();
            document.getElementById('pin-error').classList.add('opacity-0');
        }
        function updateDots() {
            document.querySelectorAll('.pin-dot').forEach((dot, i) => {
                dot.classList.toggle('bg-blue-600', i < currentPin.length);
                dot.classList.toggle('border-blue-600', i < currentPin.length);
            });
        }
        function checkPin() {
            if (currentPin === PIN_SECRET) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                document.getElementById('dashboard-section').classList.add('flex');
            } else {
                document.getElementById('pin-error').classList.remove('opacity-0');
                currentPin = "";
                updateDots();
            }
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const wb = document.getElementById('wallet-balance');
            const sb = document.getElementById('savings-balance');
            const ta = document.getElementById('total-assets');

            if (isHidden) {
                wb.innerText = "Rp •••••••"; sb.innerText = "Rp •••••"; ta.innerText = "Rp •••••••";
            } else {
                wb.innerText = formatCurrency(balance);
                sb.innerText = formatCurrency(savings);
                ta.innerText = formatCurrency(balance + savings);
            }

            const list = document.getElementById('dashboard-history-list');
            list.innerHTML = "";
            const recent = [...transactions].reverse().slice(0, 10);
            
            if (recent.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm">No activities yet.</div>`;
            } else {
                recent.forEach(t => list.appendChild(createActivityItem(t)));
            }
        }

        function createActivityItem(t) {
            const div = document.createElement('div');
            div.className = "bg-white p-3 rounded-2xl flex items-center justify-between border border-gray-100 active:scale-95 transition cursor-pointer";
            div.onclick = () => openDetail(t);

            let icon, color;
            if (t.type === 'in') {
                icon = 'fa-arrow-down'; color = 'text-green-600 bg-green-50';
            } else if (t.type === 'out') {
                icon = 'fa-arrow-up'; color = 'text-red-600 bg-red-50';
            } else if (t.type === 'save') {
                icon = 'fa-piggy-bank'; color = 'text-blue-600 bg-blue-50';
            } else {
                icon = 'fa-hand-holding-dollar'; color = 'text-yellow-600 bg-yellow-50';
            }

            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${color} text-sm">
                        <i class="fa-solid ${icon}"></i>
                    </div>
                    <div>
                        <p class="font-bold text-gray-800 text-sm capitalize truncate w-32">${t.desc}</p>
                        <p class="text-[10px] text-gray-400 font-medium">${t.dateShort} • ${t.time}</p>
                    </div>
                </div>
                <p class="font-bold text-sm ${t.type === 'in' ? 'text-green-600' : (t.type === 'out' ? 'text-red-600' : (t.type === 'save' ? 'text-blue-600' : 'text-yellow-600'))}">
                    ${formatCurrency(t.amount)}
                </p>
            `;
            return div;
        }

        // --- BANK LOGIC ---
        function generateSavingOptions() {
            const now = new Date();
            const month = now.toLocaleString('en-US', { month: 'long' });
            const year = now.getFullYear();
            const select = document.getElementById('bank-desc-saving');
            
            const options = [
                `Saving - Salary ${month} ${year}`,
                `Saving - Week 1 ${month} ${year}`,
                `Saving - Week 2 ${month} ${year}`,
                `Saving - Week 3 ${month} ${year}`,
                `Saving - Week 4 ${month} ${year}`,
                `Saving - Week 5 ${month} ${year}`
            ];
            
            select.innerHTML = `<option value="">- Default Description -</option>` + 
                               options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        function setBankMode(mode) {
            bankMode = mode;
            const btn = document.getElementById('bank-submit-btn');
            
            document.getElementById('toggle-save').className = `toggle-btn flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${mode === 'save' ? 'active-blue' : ''}`;
            document.getElementById('toggle-withdraw').className = `toggle-btn flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${mode === 'withdraw' ? 'active-yellow' : ''}`;
            
            document.getElementById('bank-desc-saving').classList.toggle('hidden', mode !== 'save');
            document.getElementById('bank-desc-withdraw').classList.toggle('hidden', mode !== 'withdraw');
            
            if (mode === 'save') {
                btn.className = "w-full py-4 rounded-xl bg-blue-600 text-white font-bold text-lg shadow-lg active:scale-[0.98] transition";
                btn.innerText = "Confirm Saving";
            } else {
                btn.className = "w-full py-4 rounded-xl bg-yellow-500 text-white font-bold text-lg shadow-lg active:scale-[0.98] transition";
                btn.innerText = "Confirm Withdraw";
            }
        }

        function openBankModal() {
            setBankMode('save');
            document.getElementById('bank-amount').value = '';
            document.getElementById('bank-desc-saving').value = '';
            document.getElementById('bank-desc-withdraw').value = '';
            document.getElementById('bank-modal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('bank-modal').classList.remove('opacity-0');
                document.getElementById('bank-modal-content').classList.remove('translate-y-full');
            }, 10);
        }

        function closeBankModal() {
            document.getElementById('bank-modal').classList.add('opacity-0');
            document.getElementById('bank-modal-content').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('bank-modal').classList.add('hidden'), 300);
        }

        function handleBankSubmit(e) {
            e.preventDefault();
            const amt = parseCurrency(document.getElementById('bank-amount').value);
            if (!amt || amt <= 0) return;

            let desc = '';
            if (bankMode === 'save') {
                if (amt > balance) { alert("Insufficient wallet balance!"); return; }
                desc = document.getElementById('bank-desc-saving').value || "In - Saving";
                balance -= amt; savings += amt;
            } else {
                if (amt > savings) { alert("Insufficient savings balance!"); return; }
                desc = document.getElementById('bank-desc-withdraw').value || "Out - Saving";
                savings -= amt; balance += amt;
            }
            
            addTransaction(bankMode, amt, desc);
            closeBankModal();
        }

        // --- TRANS LOGIC ---
        function openModal(type) {
            document.getElementById('trans-type').value = type;
            document.getElementById('trans-amount').value = '';
            document.getElementById('trans-desc').value = '';
            document.getElementById('modal-title').innerText = type === 'in' ? "New Income" : "New Expense";
            
            const btn = document.getElementById('modal-submit-btn');
            btn.className = `w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg active:scale-[0.98] transition ${type === 'in' ? 'bg-green-600' : 'bg-red-600'}`;

            document.getElementById('transaction-modal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('transaction-modal').classList.remove('opacity-0');
                document.getElementById('trans-modal-content').classList.remove('translate-y-full');
            }, 10);
        }

        function closeModal() {
            document.getElementById('transaction-modal').classList.add('opacity-0');
            document.getElementById('trans-modal-content').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('transaction-modal').classList.add('hidden'), 300);
        }

        function handleTransSubmit(e) {
            e.preventDefault();
            const type = document.getElementById('trans-type').value;
            const amt = parseCurrency(document.getElementById('trans-amount').value);
            if (!amt || amt <= 0) return;

            let desc = document.getElementById('trans-desc').value;
            if (!desc) desc = type === 'in' ? "Income" : "Expense";
            
            if (type === 'out' && amt > balance) { alert("Insufficient wallet balance!"); return; }
            if (type === 'in') balance += amt; else balance -= amt;
            
            addTransaction(type, amt, desc);
            closeModal();
        }

        function addTransaction(type, amount, desc) {
            const now = new Date();
            transactions.push({
                id: Date.now(),
                type, amount, desc,
                dateRaw: now.toISOString().split('T')[0],
                dateShort: now.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }),
                dateFull: now.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }),
                time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
            });
            saveData();
            renderDashboard();
        }

        function toggleBalance() { isHidden = !isHidden; renderDashboard(); }

        function openDetail(t) {
            const modal = document.getElementById('detail-modal');
            const card = document.getElementById('detail-card-content');
            document.getElementById('det-desc').innerText = t.desc;
            document.getElementById('det-amount').innerText = formatCurrency(t.amount);
            document.getElementById('det-date').innerText = t.dateFull;
            document.getElementById('det-time').innerText = t.time;

            const iconBg = document.getElementById('det-icon-bg');
            const icon = document.getElementById('det-icon');
            const typeText = document.getElementById('det-type');

            if (t.type === 'in') {
                iconBg.className = "w-14 h-14 rounded-full flex items-center justify-center mb-4 bg-green-100 text-green-600";
                icon.className = "fa-solid fa-arrow-down"; typeText.innerText = "Income";
            } else if (t.type === 'out') {
                iconBg.className = "w-14 h-14 rounded-full flex items-center justify-center mb-4 bg-red-100 text-red-600";
                icon.className = "fa-solid fa-arrow-up"; typeText.innerText = "Expense";
            } else if (t.type === 'save') {
                iconBg.className = "w-14 h-14 rounded-full flex items-center justify-center mb-4 bg-blue-100 text-blue-600";
                icon.className = "fa-solid fa-piggy-bank"; typeText.innerText = "Saving In";
            } else {
                iconBg.className = "w-14 h-14 rounded-full flex items-center justify-center mb-4 bg-yellow-100 text-yellow-600";
                icon.className = "fa-solid fa-hand-holding-dollar"; typeText.innerText = "Saving Out";
            }

            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); card.classList.remove('scale-95'); }, 10);
        }

        function closeDetail() {
            const modal = document.getElementById('detail-modal');
            const card = document.getElementById('detail-card-content');
            modal.classList.add('opacity-0'); card.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function showFullHistory() {
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('history-section').classList.remove('hidden').classList.add('flex');
            
            const cont = document.getElementById('full-history-container');
            cont.innerHTML = "";
            const grouped = {};
            [...transactions].reverse().forEach(t => {
                if (!grouped[t.dateFull]) grouped[t.dateFull] = [];
                grouped[t.dateFull].push(t);
            });

            Object.keys(grouped).forEach(date => {
                const group = document.createElement('div');
                group.className = "mb-6";
                group.innerHTML = `<p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 ml-1">${date}</p>`;
                const list = document.createElement('div');
                list.className = "space-y-3";
                grouped[date].forEach(t => list.appendChild(createActivityItem(t)));
                group.appendChild(list);
                cont.appendChild(group);
            });
        }

        function showDashboard() {
            document.getElementById('history-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
        }

        function saveData() {
            localStorage.setItem('qrees_bal', balance);
            localStorage.setItem('qrees_sav', savings);
            localStorage.setItem('qrees_trx', JSON.stringify(transactions));
        }

        function loadData() {
            balance = parseInt(localStorage.getItem('qrees_bal')) || 0;
            savings = parseInt(localStorage.getItem('qrees_sav')) || 0;
            transactions = JSON.parse(localStorage.getItem('qrees_trx')) || [];
        }
    </script>
</body>
</html>
