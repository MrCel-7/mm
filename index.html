<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QREES - Elite Money Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #1A1A1A;
            --accent: #FF9F1C;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f0f0f;
            color: #ffffff;
            overflow: hidden;
            user-select: none;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-text {
            background: linear-gradient(45deg, #FF6B35, #FF9F1C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Navigation Active State */
        .nav-item.active {
            color: var(--primary);
        }
        .nav-item.active i {
            transform: translateY(-5px);
            text-shadow: 0 4px 10px rgba(255, 107, 53, 0.5);
        }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

        .custom-shadow {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center">

    <!-- ================= LOGIN PAGE ================= -->
    <div id="login-section" class="fixed inset-0 z-[100] bg-[#0f0f0f] flex flex-col items-center justify-center p-8 transition-all duration-500">
        <div class="w-full max-w-sm text-center">
            <div class="relative inline-block mb-10">
                <div class="w-24 h-24 bg-gradient-to-tr from-[#FF6B35] to-[#FF9F1C] rounded-[2rem] flex items-center justify-center shadow-2xl shadow-orange-900/40 rotate-12">
                    <i class="fa-solid fa-bolt-lightning text-white text-4xl -rotate-12"></i>
                </div>
            </div>
            <h1 class="text-3xl font-extrabold tracking-tight mb-2">QREES <span class="gradient-text text-orange-500">ELITE</span></h1>
            <p class="text-gray-500 text-sm mb-12">Secure entry with your master PIN</p>

            <div class="flex justify-center gap-4 mb-10" id="pin-display">
                <!-- PIN dots handled by JS -->
            </div>

            <div id="login-keypad" class="grid grid-cols-3 gap-6 max-w-[300px] mx-auto">
                <!-- Numbers generated by JS -->
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP WRAPPER ================= -->
    <div id="app-content" class="hidden w-full max-w-md h-screen bg-[#0f0f0f] flex flex-col relative overflow-hidden">
        
        <!-- Tab Content: Dashboard -->
        <div id="tab-home" class="tab-pane flex-1 overflow-y-auto no-scrollbar px-6 pt-12 pb-32">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <p class="text-gray-500 text-xs font-bold uppercase tracking-widest">Wealth Level</p>
                    <div class="flex items-center gap-2">
                        <span id="wealth-rank" class="text-lg font-bold gradient-text">Elite Member</span>
                        <i class="fa-solid fa-crown text-amber-400 text-xs"></i>
                    </div>
                </div>
                <div class="w-12 h-12 rounded-full border-2 border-orange-500/30 p-1">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-full h-full rounded-full bg-gray-800" alt="Avatar">
                </div>
            </header>

            <!-- Card Showcase -->
            <div class="relative group mb-8">
                <div class="bg-gradient-to-br from-[#FF6B35] to-[#D84315] rounded-[2.5rem] p-8 text-white shadow-2xl shadow-orange-900/30 relative overflow-hidden transition-all">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-10">
                            <div>
                                <p class="text-white/60 text-xs font-bold uppercase tracking-widest mb-1">Total Assets</p>
                                <h2 id="display-total-balance" class="text-3xl font-extrabold tracking-tight">Rp 0</h2>
                            </div>
                            <div class="bg-black/20 p-2 rounded-xl backdrop-blur-md">
                                <i class="fa-solid fa-shield-halved text-orange-200"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white/10 p-4 rounded-2xl backdrop-blur-sm">
                                <p class="text-white/50 text-[10px] uppercase font-bold mb-1">In Wallet</p>
                                <p id="display-wallet" class="font-bold text-sm">Rp 0</p>
                            </div>
                            <div class="bg-white/10 p-4 rounded-2xl backdrop-blur-sm">
                                <p class="text-white/50 text-[10px] uppercase font-bold mb-1">In Bank</p>
                                <p id="display-savings" class="font-bold text-sm">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="glass-card rounded-3xl p-5 mb-8 flex justify-between items-center">
                <div class="flex flex-col items-center flex-1 border-r border-white/10">
                    <span class="text-[10px] text-gray-500 font-bold uppercase mb-1">Daily Burn</span>
                    <span id="stat-burn" class="text-red-400 font-bold">Rp 0</span>
                </div>
                <div class="flex flex-col items-center flex-1">
                    <span class="text-[10px] text-gray-500 font-bold uppercase mb-1">Efficiency</span>
                    <span id="stat-efficiency" class="text-green-400 font-bold">94%</span>
                </div>
            </div>

            <!-- Budgeting Section -->
            <div class="mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="font-bold text-lg">Monthly Budget</h3>
                    <button onclick="setBudget()" class="text-orange-500 text-xs font-bold">Adjust</button>
                </div>
                <div class="glass-card rounded-2xl p-5">
                    <div class="flex justify-between text-xs mb-2">
                        <span class="text-gray-400">Used: <span id="budget-used" class="text-white font-bold">Rp 0</span></span>
                        <span class="text-gray-400">Limit: <span id="budget-limit" class="text-white font-bold">Rp 5.000.000</span></span>
                    </div>
                    <div class="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                        <div id="budget-bar" class="h-full bg-gradient-to-r from-orange-500 to-red-500 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Recent History -->
            <div>
                <div class="flex justify-between items-center mb-5">
                    <h3 class="font-bold text-lg">Timeline</h3>
                    <button onclick="switchTab('history')" class="text-orange-500 text-xs font-bold">View All</button>
                </div>
                <div id="home-history-list" class="space-y-4">
                    <!-- History items -->
                </div>
            </div>
        </div>

        <!-- Tab Content: Analytics -->
        <div id="tab-analytics" class="tab-pane hidden flex-1 overflow-y-auto no-scrollbar px-6 pt-12 pb-32">
            <h2 class="text-2xl font-bold mb-8">Financial <span class="gradient-text">Insights</span></h2>
            
            <div class="glass-card rounded-[2rem] p-6 mb-8">
                <canvas id="expenseChart" class="w-full"></canvas>
            </div>

            <div class="space-y-4">
                <h3 class="font-bold text-gray-400 text-xs uppercase tracking-widest">Spending Categories</h3>
                <div id="category-distribution" class="space-y-3">
                    <!-- Categories -->
                </div>
            </div>
        </div>

        <!-- Tab Content: History -->
        <div id="tab-history" class="tab-pane hidden flex-1 overflow-y-auto no-scrollbar px-6 pt-12 pb-32">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold">Global Archive</h2>
                <button onclick="exportData()" class="p-2 bg-white/5 rounded-xl text-orange-500"><i class="fa-solid fa-download"></i></button>
            </div>
            <div id="full-history-list" class="space-y-6">
                <!-- Grouped History -->
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto h-24 glass-card border-t border-white/10 px-8 flex justify-between items-center z-50">
            <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center transition-all duration-300">
                <i class="fa-solid fa-house-chimney text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-tight">Home</span>
            </button>
            <button onclick="switchTab('analytics')" class="nav-item flex flex-col items-center transition-all duration-300">
                <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-tight">Stats</span>
            </button>
            <div class="relative -top-8">
                <button onclick="showActionSheet()" class="w-16 h-16 bg-gradient-to-tr from-orange-500 to-red-600 rounded-full shadow-2xl shadow-orange-600/50 flex items-center justify-center text-white text-2xl active:scale-90 transition">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
            <button onclick="switchTab('history')" class="nav-item flex flex-col items-center transition-all duration-300">
                <i class="fa-solid fa-receipt text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-tight">Logs</span>
            </button>
            <button onclick="logout()" class="nav-item flex flex-col items-center transition-all duration-300">
                <i class="fa-solid fa-power-off text-xl mb-1 text-red-500/50"></i>
                <span class="text-[10px] font-bold uppercase tracking-tight">Exit</span>
            </button>
        </nav>
    </div>

    <!-- ================= ACTION SHEET MODAL ================= -->
    <div id="action-sheet" class="fixed inset-0 z-[110] hidden bg-black/80 backdrop-blur-sm flex items-end justify-center p-4">
        <div class="w-full max-w-md bg-[#1a1a1a] rounded-[2.5rem] p-8 animate-slide-up">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold">Select Action</h3>
                <button onclick="hideActionSheet()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openTransactionModal('in')" class="glass-card p-6 rounded-3xl flex flex-col items-center gap-3 active:bg-orange-500/10 transition">
                    <div class="w-12 h-12 bg-green-500/20 text-green-500 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-plus-circle"></i></div>
                    <span class="font-bold text-xs uppercase tracking-widest">Income</span>
                </button>
                <button onclick="openTransactionModal('out')" class="glass-card p-6 rounded-3xl flex flex-col items-center gap-3 active:bg-orange-500/10 transition">
                    <div class="w-12 h-12 bg-red-500/20 text-red-500 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-minus-circle"></i></div>
                    <span class="font-bold text-xs uppercase tracking-widest">Expense</span>
                </button>
                <button onclick="openBankAction('save')" class="glass-card p-6 rounded-3xl flex flex-col items-center gap-3 active:bg-orange-500/10 transition">
                    <div class="w-12 h-12 bg-blue-500/20 text-blue-500 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-vault"></i></div>
                    <span class="font-bold text-xs uppercase tracking-widest text-center">Save to Bank</span>
                </button>
                <button onclick="openBankAction('withdraw')" class="glass-card p-6 rounded-3xl flex flex-col items-center gap-3 active:bg-orange-500/10 transition">
                    <div class="w-12 h-12 bg-amber-500/20 text-amber-500 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-money-bill-transfer"></i></div>
                    <span class="font-bold text-xs uppercase tracking-widest text-center">Withdraw</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ================= TRANSACTION MODAL ================= -->
    <div id="trans-modal" class="fixed inset-0 z-[120] hidden bg-black/90 flex items-center justify-center p-6">
        <div class="w-full max-w-sm glass-card rounded-[3rem] p-8 border-orange-500/20">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-center">New Entry</h2>
            
            <div class="mb-8">
                <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Amount</label>
                <input type="text" id="input-amount" oninput="formatCurrencyInput(this)" class="w-full bg-transparent text-4xl font-extrabold outline-none border-b border-white/10 py-2 text-white focus:border-orange-500" placeholder="0" inputmode="numeric">
            </div>

            <div class="mb-8">
                <label class="text-[10px] font-bold text-gray-500 uppercase block mb-4">Category</label>
                <div class="grid grid-cols-4 gap-3" id="category-grid">
                    <!-- Categories -->
                </div>
            </div>

            <div class="mb-8">
                <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Note</label>
                <input type="text" id="input-note" class="w-full bg-white/5 rounded-xl px-4 py-3 outline-none focus:ring-1 ring-orange-500" placeholder="Dinner, Salary, etc.">
            </div>

            <div class="flex gap-3">
                <button onclick="closeTransModal()" class="flex-1 py-4 bg-white/5 rounded-2xl font-bold text-gray-400">Cancel</button>
                <button onclick="saveTransaction()" class="flex-[2] py-4 bg-orange-600 rounded-2xl font-bold shadow-xl shadow-orange-900/40">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & STATE ---
        const MASTER_PIN = "501943";
        let state = {
            wallet: 0,
            savings: 0,
            transactions: [],
            budget: 5000000,
            currentPin: "",
            activeCategory: 'Others',
            chart: null
        };

        const categories = [
            { name: 'Food', icon: 'fa-utensils', color: 'bg-orange-500' },
            { name: 'Transport', icon: 'fa-car', color: 'bg-blue-500' },
            { name: 'Shopping', icon: 'fa-bag-shopping', color: 'bg-purple-500' },
            { name: 'Entertainment', icon: 'fa-gamepad', color: 'bg-red-500' },
            { name: 'Health', icon: 'fa-heart-pulse', color: 'bg-pink-500' },
            { name: 'Bills', icon: 'fa-receipt', color: 'bg-amber-500' },
            { name: 'Work', icon: 'fa-briefcase', color: 'bg-indigo-500' },
            { name: 'Others', icon: 'fa-ellipsis', color: 'bg-gray-500' }
        ];

        // --- CORE FUNCTIONS ---
        window.onload = () => {
            initLogin();
            loadData();
            updateUI();
        };

        function initLogin() {
            const keypad = document.getElementById('login-keypad');
            const display = document.getElementById('pin-display');
            
            // Generate dots
            for(let i=0; i<6; i++) {
                const dot = document.createElement('div');
                dot.className = "pin-dot w-4 h-4 rounded-full border-2 border-white/20 transition-all";
                display.appendChild(dot);
            }

            // Generate numbers
            const nums = [1,2,3,4,5,6,7,8,9, 'x', 0, '<'];
            nums.forEach(n => {
                const btn = document.createElement('button');
                btn.className = "w-full aspect-square rounded-2xl glass-card flex items-center justify-center text-xl font-bold active:bg-orange-500 transition-colors";
                if(n === '<') {
                    btn.innerHTML = '<i class="fa-solid fa-delete-left"></i>';
                    btn.onclick = () => handlePinInput('back');
                } else if(n === 'x') {
                    btn.innerText = '';
                    btn.disabled = true;
                    btn.className = "w-full aspect-square";
                } else {
                    btn.innerText = n;
                    btn.onclick = () => handlePinInput(n);
                }
                keypad.appendChild(btn);
            });
        }

        function handlePinInput(val) {
            if(val === 'back') {
                state.currentPin = state.currentPin.slice(0, -1);
            } else if(state.currentPin.length < 6) {
                state.currentPin += val;
            }

            // Update dots
            document.querySelectorAll('.pin-dot').forEach((dot, i) => {
                if(i < state.currentPin.length) {
                    dot.classList.add('bg-orange-500', 'border-orange-500', 'shadow-[0_0_10px_rgba(255,107,53,0.8)]');
                } else {
                    dot.classList.remove('bg-orange-500', 'border-orange-500', 'shadow-[0_0_10px_rgba(255,107,53,0.8)]');
                }
            });

            if(state.currentPin.length === 6) {
                setTimeout(() => {
                    if(state.currentPin === MASTER_PIN) {
                        document.getElementById('login-section').classList.add('opacity-0', 'pointer-events-none', 'scale-110');
                        document.getElementById('app-content').classList.remove('hidden');
                        state.currentPin = "";
                    } else {
                        state.currentPin = "";
                        handlePinInput('reset');
                        // Vibrate/Shake effect here if possible
                    }
                }, 300);
            }
        }

        function logout() {
            document.getElementById('login-section').classList.remove('opacity-0', 'pointer-events-none', 'scale-110');
            document.getElementById('app-content').classList.add('hidden');
            handlePinInput('back');
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            event.currentTarget.classList.add('active');

            if(tabId === 'analytics') renderCharts();
            if(tabId === 'history') renderFullHistory();
        }

        // --- TRANSACTION LOGIC ---
        let currentModalType = 'in';

        function showActionSheet() { document.getElementById('action-sheet').classList.remove('hidden'); }
        function hideActionSheet() { document.getElementById('action-sheet').classList.add('hidden'); }

        function openTransactionModal(type) {
            currentModalType = type;
            hideActionSheet();
            document.getElementById('modal-title').innerText = type === 'in' ? 'Elite Income' : 'Essential Expense';
            document.getElementById('input-amount').value = "";
            document.getElementById('input-note').value = "";
            
            // Render Categories
            const grid = document.getElementById('category-grid');
            grid.innerHTML = "";
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `flex flex-col items-center p-3 rounded-2xl glass-card transition-all ${state.activeCategory === cat.name ? 'ring-2 ring-orange-500' : ''}`;
                btn.onclick = () => {
                    state.activeCategory = cat.name;
                    openTransactionModal(type); // Re-render to show active
                };
                btn.innerHTML = `
                    <div class="w-10 h-10 rounded-xl ${cat.color} flex items-center justify-center mb-1 text-sm"><i class="fa-solid ${cat.icon}"></i></div>
                    <span class="text-[8px] font-bold uppercase truncate w-full text-center">${cat.name}</span>
                `;
                grid.appendChild(btn);
            });

            document.getElementById('trans-modal').classList.remove('hidden');
        }

        function closeTransModal() { document.getElementById('trans-modal').classList.add('hidden'); }

        function saveTransaction() {
            const rawAmt = document.getElementById('input-amount').value.replace(/\D/g, '');
            const amount = parseInt(rawAmt);
            const note = document.getElementById('input-note').value || state.activeCategory;

            if(!amount) return;

            if(currentModalType === 'out' && amount > state.wallet) {
                alert("Low Balance! Manage your elite assets wisely.");
                return;
            }

            const trans = {
                id: Date.now(),
                type: currentModalType,
                category: state.activeCategory,
                amount: amount,
                note: note,
                timestamp: new Date()
            };

            if(currentModalType === 'in') state.wallet += amount;
            else state.wallet -= amount;

            state.transactions.push(trans);
            saveData();
            updateUI();
            closeTransModal();
        }

        function openBankAction(mode) {
            const amtStr = prompt(mode === 'save' ? "Amount to Save to Bank:" : "Amount to Withdraw from Bank:");
            const amount = parseInt(amtStr);
            if(isNaN(amount) || amount <= 0) return;

            if(mode === 'save') {
                if(amount > state.wallet) return alert("Wallet balance low.");
                state.wallet -= amount;
                state.savings += amount;
                state.transactions.push({ id: Date.now(), type: 'save', category: 'Others', amount: amount, note: 'Saved to Bank', timestamp: new Date() });
            } else {
                if(amount > state.savings) return alert("Bank balance low.");
                state.savings -= amount;
                state.wallet += amount;
                state.transactions.push({ id: Date.now(), type: 'withdraw', category: 'Others', amount: amount, note: 'Withdrawn from Bank', timestamp: new Date() });
            }
            hideActionSheet();
            saveData();
            updateUI();
        }

        // --- UI UPDATES ---
        function updateUI() {
            document.getElementById('display-total-balance').innerText = formatCurrency(state.wallet + state.savings);
            document.getElementById('display-wallet').innerText = formatCurrency(state.wallet);
            document.getElementById('display-savings').innerText = formatCurrency(state.savings);

            // Wealth Level Logic
            const total = state.wallet + state.savings;
            let rank = "Bronze Member";
            if(total > 100000000) rank = "Sultan Elite";
            else if(total > 50000000) rank = "Golden Knight";
            else if(total > 10000000) rank = "Platinum Member";
            document.getElementById('wealth-rank').innerText = rank;

            // Budget Update
            const monthlyOut = state.transactions
                .filter(t => t.type === 'out' && new Date(t.timestamp).getMonth() === new Date().getMonth())
                .reduce((acc, curr) => acc + curr.amount, 0);
            
            document.getElementById('budget-used').innerText = formatCurrency(monthlyOut);
            document.getElementById('budget-limit').innerText = formatCurrency(state.budget);
            const perc = Math.min((monthlyOut / state.budget) * 100, 100);
            document.getElementById('budget-bar').style.width = perc + "%";
            document.getElementById('stat-burn').innerText = formatCurrency(monthlyOut / 30);

            renderHomeHistory();
        }

        function renderHomeHistory() {
            const list = document.getElementById('home-history-list');
            list.innerHTML = "";
            const recent = [...state.transactions].reverse().slice(0, 5);

            recent.forEach(t => {
                const cat = categories.find(c => c.name === t.category) || categories[7];
                const div = document.createElement('div');
                div.className = "glass-card p-4 rounded-3xl flex items-center justify-between";
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-11 h-11 rounded-2xl ${cat.color}/20 text-${cat.color.split('-')[1]}-500 flex items-center justify-center">
                            <i class="fa-solid ${cat.icon}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold truncate w-24">${t.note}</p>
                            <p class="text-[10px] text-gray-500 font-bold uppercase">${cat.name}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-extrabold ${t.type === 'in' ? 'text-green-500' : 'text-red-500'}">
                            ${t.type === 'in' ? '+' : '-'}${formatCurrency(t.amount)}
                        </p>
                        <p class="text-[10px] text-gray-600 font-mono">${new Date(t.timestamp).getHours()}:${String(new Date(t.timestamp).getMinutes()).padStart(2,'0')}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderCharts() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const expByCat = {};
            state.transactions.filter(t => t.type === 'out').forEach(t => {
                expByCat[t.category] = (expByCat[t.category] || 0) + t.amount;
            });

            if(state.chart) state.chart.destroy();
            
            state.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expByCat),
                    datasets: [{
                        data: Object.values(expByCat),
                        backgroundColor: ['#FF6B35', '#3B82F6', '#A855F7', '#EF4444', '#EC4899', '#F59E0B', '#6366F1', '#6B7280'],
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    cutout: '75%',
                }
            });

            // Dist list
            const dist = document.getElementById('category-distribution');
            dist.innerHTML = "";
            Object.entries(expByCat).sort((a,b) => b[1] - a[1]).forEach(([name, val]) => {
                const cat = categories.find(c => c.name === name);
                const item = document.createElement('div');
                item.className = "flex justify-between items-center";
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full ${cat.color}"></div>
                        <span class="text-xs font-bold text-gray-400 uppercase">${name}</span>
                    </div>
                    <span class="text-sm font-bold">${formatCurrency(val)}</span>
                `;
                dist.appendChild(item);
            });
        }

        // --- DATA MGMT ---
        function formatCurrency(num) {
            return "Rp " + new Intl.NumberFormat('id-ID').format(num);
        }

        function formatCurrencyInput(el) {
            let val = el.value.replace(/\D/g, '');
            el.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function saveData() {
            localStorage.setItem('qrees_elite_v1', JSON.stringify({
                wallet: state.wallet,
                savings: state.savings,
                transactions: state.transactions,
                budget: state.budget
            }));
        }

        function loadData() {
            const saved = JSON.parse(localStorage.getItem('qrees_elite_v1'));
            if(saved) {
                state.wallet = saved.wallet;
                state.savings = saved.savings;
                state.transactions = saved.transactions;
                state.budget = saved.budget || 5000000;
            }
        }

        function setBudget() {
            const res = prompt("Set Monthly Limit (IDR):", state.budget);
            if(res) {
                state.budget = parseInt(res);
                saveData();
                updateUI();
            }
        }

        function renderFullHistory() {
            const container = document.getElementById('full-history-list');
            container.innerHTML = "";
            const grouped = {};
            [...state.transactions].reverse().forEach(t => {
                const date = new Date(t.timestamp).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
                if(!grouped[date]) grouped[date] = [];
                grouped[date].push(t);
            });

            for(const [date, items] of Object.entries(grouped)) {
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = `<h4 class="text-[10px] font-bold text-gray-600 uppercase tracking-widest mb-4 ml-1">${date}</h4>`;
                const list = document.createElement('div');
                list.className = "space-y-4";
                items.forEach(t => {
                    const cat = categories.find(c => c.name === t.category) || categories[7];
                    const item = document.createElement('div');
                    item.className = "glass-card p-4 rounded-3xl flex justify-between items-center";
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                             <div class="w-10 h-10 rounded-xl ${cat.color}/20 text-${cat.color.split('-')[1]}-500 flex items-center justify-center"><i class="fa-solid ${cat.icon}"></i></div>
                             <div>
                                <p class="text-sm font-bold">${t.note}</p>
                                <p class="text-[9px] text-gray-500 uppercase font-bold">${t.type}</p>
                             </div>
                        </div>
                        <span class="font-bold ${t.type === 'in' ? 'text-green-500' : 'text-red-500'}">${formatCurrency(t.amount)}</span>
                    `;
                    list.appendChild(item);
                });
                groupDiv.appendChild(list);
                container.appendChild(groupDiv);
            }
        }
    </script>
</body>
</html>
